name: Auto Merge PR from master to develop

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened

jobs:
  auto_merge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Check if PR is from master to develop
        run: |
          SOURCE_BRANCH=$(jq -r .pull_request.head.ref "$GITHUB_EVENT_PATH")
          TARGET_BRANCH=$(jq -r .pull_request.base.ref "$GITHUB_EVENT_PATH")

          if [[ "$SOURCE_BRANCH" == "develop" && "$TARGET_BRANCH" == "master" ]]; then
            echo "PR is not from master to develop. Exiting."
            exit 0
          else
            echo "PR is from master to develop. Proceeding with approval and merge."
          fi

      - name: Approve and Merge PR
        run: |
          PR_NUMBER=$(jq -r .pull_request.number "$GITHUB_EVENT_PATH")
          API_URL="https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls/${PR_NUMBER}"

          # Approve the PR
          curl -X POST -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$API_URL/reviews" -d '{"event": "APPROVE"}'

          # Wait for a few seconds (optional, to allow approval to register)
          sleep 5

          # Merge the PR
          curl -X PUT -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "$API_URL/merge"
